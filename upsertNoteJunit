@Test
public void testInsertClosingDossierNote_PostMigration_NoExistingMacaoNote() throws Exception {
    LocalDateTime original = LocalDateTime.of(2025,5,12,10,0);
    Note note = new Note(0L, "FILE123", original, "post-mig note");

    // … stub out risk/ref queries so isPreMigration()==false …
    // … stub out postStmt so rsNotes.next() == false …

    // —– HERE’S THE ONLY CHANGE —–
    PreparedStatement primaryInsert = mock(PreparedStatement.class);
    PreparedStatement closeStmt     = mock(PreparedStatement.class);

    when(connection.prepareStatement(startsWith("INSERT INTO Notes")))
      .thenReturn(primaryInsert)   // first call → the migration-note insert
      .thenReturn(closeStmt);      // second call → the dossier-close insert

    when(primaryInsert.executeUpdate()).thenReturn(1);
    when(closeStmt.executeUpdate()).thenReturn(1);
    // —– END CHANGE —–

    service.upsertNote(note, original);

    // capture *only* the closing-dossier timestamp
    ArgumentCaptor<Timestamp> tsCaptor = ArgumentCaptor.forClass(Timestamp.class);
    verify(closeStmt).setTimestamp(eq(2), tsCaptor.capture());
    Assertions.assertEquals(
      Timestamp.valueOf(original.plusMinutes(2)),
      tsCaptor.getValue()
    );

    verify(closeStmt).setString(eq(4),
      eq("Dossier cloturé sans demande de conseil"));
    verify(closeStmt).executeUpdate();
}